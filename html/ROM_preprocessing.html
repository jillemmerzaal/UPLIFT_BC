
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>ROM_preprocessing</title><meta name="generator" content="MATLAB 9.11"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2022-10-24"><meta name="DC.source" content="ROM_preprocessing.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">Extract the range of motion data and write to excel.</a></li><li><a href="#2">1. input data</a></li><li><a href="#3">2. load data</a></li><li><a href="#5">2.1 Load xsens data</a></li><li><a href="#8">normalise the data to 100 data points</a></li></ul></div><h2 id="1">Extract the range of motion data and write to excel.</h2><p>This code extracts the range of motion timecurve as calculated by the xsens system. Data collected with Xsens MVN 2021.2. Nescesary functions:       1) MVN.m       2) load_mvnx.m code written by       dr. Jill Emmerzaal       KU Leuven, Tervuursevest 101, box 1501       Research Group for Rehabilitation in Internal Disorders</p><pre class="codeinput">clearvars; close <span class="string">all</span>; clc
</pre><h2 id="2">1. input data</h2><pre class="codeinput">cd(<span class="string">"C:\Users\u0117545\Documents\GitHub\ULIFT_BC"</span>)
addpath(<span class="string">"C:\Users\u0117545\OneDrive - KU Leuven\2.Dataprocessing\Matlab\addons"</span>)

Timepoint   = <span class="string">'T0'</span>;
movement    =  {<span class="string">'ABD'</span>};<span class="comment">%, 'AF', 'EXO'}; %Abductie'; %Abductie Anteflexie Exorotatie</span>
path.root   = <span class="string">'C:\Users\u0117545\KU Leuven\An De Groef - DATA'</span>;
<span class="comment">%path.out    = fullfile(path.root,'Output','Database_ROM.mat');</span>
plot_or_not = 1;
affected_table = readtable(fullfile(path.root, <span class="string">"Aangedane zijde.xlsx"</span>));
</pre><h2 id="3">2. load data</h2><pre class="codeinput"><span class="keyword">for</span> subj = 2<span class="comment">%(2:10)%20:27</span>
    <span class="keyword">if</span> subj &lt; 10
        subj_name   = [<span class="string">'BC_00'</span> num2str(subj)];
    <span class="keyword">elseif</span> subj &lt; 100
        subj_name   = [<span class="string">'BC_0'</span> num2str(subj)];
    <span class="keyword">else</span>
        subj_name   = [<span class="string">'BC_'</span>, num2str(subj)];
    <span class="keyword">end</span>

    fprintf(<span class="string">'\n'</span>)
    cprintf(<span class="string">'*text'</span>, <span class="string">'Processing: %s at Timepoint: %s....... \n'</span>, subj_name, Timepoint)

    path.subj   = fullfile(path.root, subj_name, <span class="string">'Xsens'</span>, Timepoint, <span class="string">'Reproces'</span>);
    check_subj  = exist(path.subj);

    <span class="keyword">if</span> check_subj == 7
        cd(path.subj)

        fprintf(<span class="string">'\t current directory changed: %s \n'</span>, path.subj)
        <span class="comment">%initialize counters</span>
        counterR        = 0;
        counterR_SSS    = 0;
        counterL        = 0;
        counterL_SSS    = 0;

        counterRUN      = 0;
        content = dir(path.subj);
        nfiles = size(content,1);
        <span class="comment">% find the affected side</span>
        idx = find(strcmp(affected_table.ppID, subj_name));
        involved = affected_table(idx,:).involved;

        d = strfind(subj_name,<span class="string">'_'</span>);
        rownr = str2double(subj_name(d+1:end));

        <span class="comment">% Start loop through files per subject</span>
        <span class="keyword">for</span> file = 1:nfiles
            <span class="keyword">if</span> contains(content(file).name, movement) &amp;&amp; contains(content(file).name, <span class="string">'.mvnx'</span>)
</pre><pre class="codeinput">                file_ik = content(file).name;
                [~,name, ~] = fileparts(content(file).name);
                [fileName] = regexprep(name, <span class="string">'-'</span>, <span class="string">'_'</span>);

                d = strfind(name,<span class="string">'_'</span>);
                arm = content(file).name(d+1);

                fprintf(<span class="string">'\t Analysing: %s \n'</span>, fileName)
                fprintf(<span class="string">'\t\t Arm of interest: %s \n'</span>,  arm)
                <span class="keyword">if</span> strcmp(arm, involved)
                    fprintf(<span class="string">'\t\t this is the affected side \n'</span>)
                <span class="keyword">else</span>
                    fprintf(<span class="string">'\t\t this is the unaffected side \n'</span>)
                <span class="keyword">end</span>
</pre><pre class="codeoutput">	 Analysing: ABD_L_001 
		 Arm of interest: L 
		 this is the affected side 
</pre><pre class="codeoutput">	 Analysing: ABD_R_001 
		 Arm of interest: R 
		 this is the unaffected side 
</pre><h2 id="5">2.1 Load xsens data</h2><p>Change the filename here to the name of the file you would like to import</p><pre class="codeinput">                fprintf(<span class="string">'\t \t %s: read xsens file \n'</span>, content(file).name)
                [sensorData, segmentData, jointData, tree]= MVN(file_ik);
                <span class="keyword">if</span> isfield(tree, <span class="string">'fileComments'</span>)
                    fprintf(<span class="string">'\t \t \t Comment in file: %s \n'</span>, tree.fileComments)
                <span class="keyword">end</span>

                <span class="keyword">if</span> contains(arm, <span class="string">'L'</span>)
                    jointno     = 12;
                <span class="keyword">else</span>
                    jointno     = 8;
                <span class="keyword">end</span>

                <span class="keyword">if</span> strcmp(movement, <span class="string">'ABD'</span>)
                    col = 1;
                    convention = <span class="string">'jointAngleXZY'</span>;
                <span class="keyword">elseif</span> strcmp(movement, <span class="string">'AF'</span>)
                    col = [];
                    convention = <span class="string">'jointAngle'</span>;
                <span class="keyword">elseif</span> strcmp(movement, <span class="string">'EXO'</span>)
                    col = [];
                    convention = <span class="string">'jointAngle'</span>;
                <span class="keyword">end</span>

                [peakLoc, peakMag] = peakfinder(jointData(jointno).(convention)(:,col), [],-5,-1,false);

                <span class="keyword">if</span> isempty(peakMag)
</pre><pre>We find the peak magnitude, and based on that mannitude
we scale sine signal to match the height of the ROM
repetition
After that, we match the sine signal with the full ROM
signal and match the individual repetitions.</pre><pre class="codeinput">                    [peakLoc, peakMag] = peakfinder(jointData(jointno).(convention)(:,col), [],[],1,false);

                    iStart = zeros(size(peakMag));
                    iStop = zeros(size(peakMag));
                    norm_data = zeros(size(peakMag,1),101);

                    figure;
                    plot(jointData(jointno).(convention)(:,col))
                    hold <span class="string">on</span>;

                    temp = jointData(jointno).(convention)(:,col);
                    <span class="keyword">for</span> idx = 1:size(peakMag,1)
</pre><pre class="codeinput">                        t=0:0.01:1;
                        f=1;
                        x = sin(pi*f*t) * peakMag(idx);

                        [iStart(idx,1), iStop(idx,1)] = findsignal(temp, x,<span class="string">'TimeAlignment'</span>,<span class="string">'dtw'</span>,<span class="string">'Metric'</span>,<span class="string">'absolute'</span>);

                        plot(iStart(idx):iStop(idx), jointData(jointno).(convention)(iStart(idx):iStop(idx),col), <span class="string">'LineWidth'</span>, 1.5)

                        temp(iStart(idx,1):iStop(idx,1)) = 0;
</pre><img vspace="5" hspace="5" src="ROM_preprocessing_01.png" alt=""> <img vspace="5" hspace="5" src="ROM_preprocessing_02.png" alt=""> <img vspace="5" hspace="5" src="ROM_preprocessing_03.png" alt=""> <img vspace="5" hspace="5" src="ROM_preprocessing_04.png" alt=""> <img vspace="5" hspace="5" src="ROM_preprocessing_05.png" alt=""> <img vspace="5" hspace="5" src="ROM_preprocessing_06.png" alt=""> <h2 id="8">normalise the data to 100 data points</h2><pre class="codeinput">                        norm_data(idx, :) = normalisation(jointData(jointno).(convention)(iStart(idx):iStop(idx),col), []);
</pre><pre class="codeinput">                    <span class="keyword">end</span>
                    clear <span class="string">temp</span>
</pre><pre>Prep data for export to excel.</pre><pre class="codeinput">                    norm_mean = mean(norm_data);

                    <span class="keyword">if</span> strcmp(arm, involved)
                        BC.aff.(Timepoint)(rownr,:) = norm_mean;
                    <span class="keyword">else</span>
                        BC.unaff.(Timepoint)(rownr,:) = norm_mean;
                    <span class="keyword">end</span>
</pre><pre class="codeinput">                <span class="keyword">else</span>
                    fprintf(<span class="string">'\t \t %s: There are lange minima \n'</span>, content(file).name)
                    fprintf(<span class="string">'\t \t check the data'</span>)
                <span class="keyword">end</span><span class="comment">% extra check in the data. If there are large minima in the data, don't perform the script</span>
</pre><pre class="codeoutput">	 	 ABD_L-001.mvnx: read xsens file 
</pre><pre class="codeoutput">	 	 ABD_R-001.mvnx: read xsens file 
</pre><pre class="codeinput">            <span class="keyword">end</span> <span class="comment">% if contains movement name and .mvnx</span>
        <span class="keyword">end</span><span class="comment">% loop through files</span>
    <span class="keyword">end</span><span class="comment">% subject exists</span>
<span class="keyword">end</span><span class="comment">% end loop through subjects</span>
</pre><pre class="codeoutput">
&lt;strong&gt;Processing: BC_002 at Timepoint: T0....... 
&lt;/strong&gt;	 current directory changed: C:\Users\u0117545\KU Leuven\An De Groef - DATA\BC_002\Xsens\T0\Reproces 
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2021b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Extract the range of motion data and write to excel.
% This code extracts the range of motion timecurve as calculated by the xsens
% system. Data collected with Xsens MVN 2021.2.
% Nescesary functions:
%       1) MVN.m
%       2) load_mvnx.m
% code written by
%       dr. Jill Emmerzaal
%       KU Leuven, Tervuursevest 101, box 1501
%       Research Group for Rehabilitation in Internal Disorders


clearvars; close all; clc
%% 1. input data
cd("C:\Users\u0117545\Documents\GitHub\ULIFT_BC")
addpath("C:\Users\u0117545\OneDrive - KU Leuven\2.Dataprocessing\Matlab\addons")

Timepoint   = 'T0';
movement    =  {'ABD'};%, 'AF', 'EXO'}; %Abductie'; %Abductie Anteflexie Exorotatie
path.root   = 'C:\Users\u0117545\KU Leuven\An De Groef - DATA';
%path.out    = fullfile(path.root,'Output','Database_ROM.mat');
plot_or_not = 1;
affected_table = readtable(fullfile(path.root, "Aangedane zijde.xlsx"));


%% 2. load data
for subj = 2%(2:10)%20:27
    if subj < 10
        subj_name   = ['BC_00' num2str(subj)];
    elseif subj < 100
        subj_name   = ['BC_0' num2str(subj)];
    else
        subj_name   = ['BC_', num2str(subj)];
    end

    fprintf('\n')
    cprintf('*text', 'Processing: %s at Timepoint: %s....... \n', subj_name, Timepoint)

    path.subj   = fullfile(path.root, subj_name, 'Xsens', Timepoint, 'Reproces');
    check_subj  = exist(path.subj);

    if check_subj == 7
        cd(path.subj)

        fprintf('\t current directory changed: %s \n', path.subj)
        %initialize counters
        counterR        = 0;
        counterR_SSS    = 0;
        counterL        = 0;
        counterL_SSS    = 0;

        counterRUN      = 0;
        content = dir(path.subj);
        nfiles = size(content,1);
        % find the affected side
        idx = find(strcmp(affected_table.ppID, subj_name));
        involved = affected_table(idx,:).involved;

        d = strfind(subj_name,'_');
        rownr = str2double(subj_name(d+1:end));

        % Start loop through files per subject
        for file = 1:nfiles
            if contains(content(file).name, movement) && contains(content(file).name, '.mvnx')
                file_ik = content(file).name;
                [~,name, ~] = fileparts(content(file).name);
                [fileName] = regexprep(name, '-', '_');

                d = strfind(name,'_');
                arm = content(file).name(d+1);

                fprintf('\t Analysing: %s \n', fileName)
                fprintf('\t\t Arm of interest: %s \n',  arm)
                if strcmp(arm, involved)
                    fprintf('\t\t this is the affected side \n')
                else
                    fprintf('\t\t this is the unaffected side \n')
                end

                %% 2.1 Load xsens data
                % Change the filename here to the name of the file you would like to import
                fprintf('\t \t %s: read xsens file \n', content(file).name)
                [sensorData, segmentData, jointData, tree]= MVN(file_ik);
                if isfield(tree, 'fileComments')
                    fprintf('\t \t \t Comment in file: %s \n', tree.fileComments)
                end

                if contains(arm, 'L')
                    jointno     = 12;
                else
                    jointno     = 8;
                end

                if strcmp(movement, 'ABD')
                    col = 1;
                    convention = 'jointAngleXZY';
                elseif strcmp(movement, 'AF')
                    col = [];
                    convention = 'jointAngle';
                elseif strcmp(movement, 'EXO')
                    col = [];
                    convention = 'jointAngle';
                end

                [peakLoc, peakMag] = peakfinder(jointData(jointno).(convention)(:,col), [],-5,-1,false);

                if isempty(peakMag)
                    %%
                    %
                    %  We find the peak magnitude, and based on that mannitude
                    %  we scale sine signal to match the height of the ROM
                    %  repetition
                    %  After that, we match the sine signal with the full ROM
                    %  signal and match the individual repetitions.
                    %

                    [peakLoc, peakMag] = peakfinder(jointData(jointno).(convention)(:,col), [],[],1,false);

                    iStart = zeros(size(peakMag));
                    iStop = zeros(size(peakMag));
                    norm_data = zeros(size(peakMag,1),101);

                    figure;
                    plot(jointData(jointno).(convention)(:,col))
                    hold on;

                    temp = jointData(jointno).(convention)(:,col);
                    for idx = 1:size(peakMag,1)
                        t=0:0.01:1;
                        f=1;
                        x = sin(pi*f*t) * peakMag(idx);

                        [iStart(idx,1), iStop(idx,1)] = findsignal(temp, x,'TimeAlignment','dtw','Metric','absolute');

                        plot(iStart(idx):iStop(idx), jointData(jointno).(convention)(iStart(idx):iStop(idx),col), 'LineWidth', 1.5)

                        temp(iStart(idx,1):iStop(idx,1)) = 0;
                        %% normalise the data to 100 data points
                        norm_data(idx, :) = normalisation(jointData(jointno).(convention)(iStart(idx):iStop(idx),col), []);
                    end
                    clear temp
                    %%
                    %
                    %  Prep data for export to excel.
                    %
                    %

                    norm_mean = mean(norm_data);
                  
                    if strcmp(arm, involved)
                        BC.aff.(Timepoint)(rownr,:) = norm_mean;
                    else
                        BC.unaff.(Timepoint)(rownr,:) = norm_mean;
                    end

                else
                    fprintf('\t \t %s: There are lange minima \n', content(file).name)
                    fprintf('\t \t check the data')
                end% extra check in the data. If there are large minima in the data, don't perform the script
            end % if contains movement name and .mvnx
        end% loop through files
    end% subject exists
end% end loop through subjects

##### SOURCE END #####
--></body></html>